// entry/src/main/ets/view/index/Home.ets
/**
 * é¦–é¡µ
 */
import { getHomeDataApi } from '../../api/home'
import { rvp } from '../../common/utils/DeviceScreen'
import { BarData, ScrollContainer } from '../../component/ScrollContainer'
import BannerListDataSource from '../../viewmodel/datasource/BannerListDataSource'
import { NavItem, PlanItem, TileItem, BannerItem } from '../../viewmodel/HomeModel'
import { Ad } from '../home/Ad'
import { NavList } from '../home/NavList'
import { PlanList } from '../home/PlanList'
import { RoomRecommend } from '../home/RoomRecommend'
import SearchBar from '../home/SearchBar'
import { SwiperLayout } from '../home/SwiperLayout'
import { TileList } from '../home/TileList'

// ç»™é¦–é¡µæŽ¥å£çš„è¿”å›žæ•°æ®è¡¥ä¸€ä¸ªæ˜¾å¼ç±»åž‹ï¼Œé¿å… data è¢«æŽ¨æˆ any
interface HomeDataModel {
  bannerList: BannerItem[];
  adPicture: string;
  navList: NavItem[];
  planList: PlanItem[];
  tileList: TileItem[];
}

@Preview
@Component
export struct Home {
  @State barData: BarData = new BarData()
  @State bannerListDataSource: BannerListDataSource = new BannerListDataSource()
  @State adPicture: string = ''
  @State navList: NavItem[] = []
  @State planList: PlanItem[] = []
  @State tileList: TileItem[] = []

  // âœ… å…³é”®ï¼šè®© Home æ„ŸçŸ¥åŒºåŸŸå˜åŒ–
  @StorageLink('currentProvinceCode') currentProvinceCode: string = ''
  @StorageLink('currentCityCode') currentCityCode: string = ''
  @StorageLink('currentDistrictCode') currentDistrictCode: string = ''

  aboutToAppear(): void {
    getHomeDataApi()
      .then((data: HomeDataModel) => {
        console.info('ðŸš€ planList æ•°æ®ï¼š', JSON.stringify(data.planList))

        this.bannerListDataSource.setList(data.bannerList)
        this.adPicture = data.adPicture
        this.navList = data.navList
        this.planList = data.planList
        this.tileList = data.tileList
      })
  }

  @Builder
  navBar() {
    SearchBar({ barData: this.barData })
  }

  @Builder
  content() {
    Column() {
      SwiperLayout({ bannerListDataSource: this.bannerListDataSource })
      Column({ space: rvp(8) }) {
        NavList({ navList: this.navList })
        TileList({ tileList: this.tileList })
        PlanList()
        Ad({ adPicture: this.adPicture })

        // âœ… å…³é”®ï¼šåŒºåŸŸå˜åŒ–æ—¶å¼ºåˆ¶é‡å»º RoomRecommend
        RoomRecommend()
          .key(`${this.currentProvinceCode}_${this.currentCityCode}_${this.currentDistrictCode}`)
      }
      .padding(rvp(16))
    }
  }

  build() {
    ScrollContainer({
      barData: this.barData,
      navBar: () => {
        this.navBar()
      },
      content: () => {
        this.content()
      }
    })
  }
}
